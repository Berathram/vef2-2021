---
title: Fyrirlestur 3.2 ‚Äì Postgres
---

# Fyrirlestur 3.2 ‚Äî Postgres

## Vefforritun 2 ‚Äî HBV403G

### √ìlafur Sverrir Kjartansson, [osk@hi.is](mailto:osk@hi.is)

---

## [PostgreSQL](https://en.wikipedia.org/wiki/PostgreSQL)

* E√∞a bara _postgres_
* Open source gagnagrunnur sem er mj√∂g √∫tbreiddur og miki√∞ nota√∞ur
* _Object-relational database management system_ (ORDBMS), miki√∞ af s√©rt√¶kri, kr√∂ftugri virkni
* _ACID_ (atomicity, consistency, isolation, durability) og √∫tf√¶rir mest allan SQL sta√∞alinn

***

## Postgres t√Ωpur

* [Sty√∞ur margar ger√∞ir af t√Ωpum](http://www.postgresql.org/docs/current/static/datatype.html)
  - Fylki, JSON, geometr√≠skar o.fl.
* Einfaldari t√Ωpur:
  - [T√∂lulegar](http://www.postgresql.org/docs/current/static/datatype-numeric.html) (integer, serial)
  - [Stafi](http://www.postgresql.org/docs/current/static/datatype-character.html) (char, varchar, text)
  - [Dagsetningar](http://www.postgresql.org/docs/current/static/datatype-datetime.html) (timestamp with time zone)

***

## Postgres ‚Äì uppsetning

* S√¶kjum og setjum upp postgres fr√° [postgresql.org](http://www.postgresql.org/)
* √Å macOS er gott a√∞ nota [homebrew](http://brew.sh/) til a√∞ setja upp
  - `brew install postgres`
  - `brew services start postgresql` til a√∞ kveikja √° √æj√≥nustu

***

* Getum lent √≠ vandr√¶√∞um me√∞ uppsetningu, s√©r √≠ lagi me√∞ notendast√Ωringu
* Hef safna√∞ saman atri√∞um sem f√≥lk hefur lent √≠, vi√∞ uppsetningu
  * [A√∞ setja upp og tengjast Postgres](../../itarefni/postgres.md)
  * L√°ti√∞ mig vita ef √æi√∞ lendi√∞ √≠ einhverju √∂√∞ru

***

## psql

* `psql` er CLI a√∞gangur a√∞ Postgres
* Getum gert allar a√∞ger√∞ir, en getur teki√∞ t√≠ma a√∞ l√¶ra √° og venjast

***

## pgAdmin

* [pgAdmin](http://www.pgadmin.org/) er graf√≠skt vi√∞m√≥t ofan √° postgres
* [S√¶kjum s√©rstaklega fyrir Windows og Mac](http://www.pgadmin.org/download/) fylgir me√∞ flestum √∫tg√°fum af Linux
* Getum √∫tb√∫i√∞ gagnagrunna, t√∂flur og allskonar

***

## Syntax

* Notar SQL me√∞ vi√∞b√≥tum
* √ñll verkefni munu byggja √° s√©√∞um d√¶mum, n√≥g a√∞ breyta √æeim (heitum, fj√∂lda d√°lka o.s.fr.) til a√∞ leysa
* Mun b√¶tast vi√∞ eftir √æv√≠ sem vi√∞ h√∂ldum √°fram

***

```sql
-- SQL Athugasemd √≠ einni l√≠nu
/*
  SQL athugasemd
  √≠ m√∂rgum l√≠num
*/

-- ; er seg√∞aendir
SELECT * FROM table;

-- A√∞ger√∞ir ekki case sensitive
select * from table;
```

***

## T√∂flur

* T√∂flur samanstanda af d√°lkum og r√∂√∞um
* D√°lkar eru vel skilgreindir me√∞ t√Ωpum, takm√∂rkunum og √Ωmsum √∂√∞rum l√Ωsig√∂gnum
* Ra√∞ir eru √æau g√∂gn sem vi√∞ b√¶tum vi√∞ t√∂fluna
  - Getum haft t√∂flur me√∞ engum r√∂√∞um, upp √≠ tugmilj√≥nir e√∞a fleiri ra√∞ir

***

## B√∫a til t√∂flu ([create table](https://www.postgresql.org/docs/current/static/sql-createtable.html))

```sql
CREATE TABLE people(
  id serial primary key,
  name varchar(64) not null unique,
  text text,
  registered boolean default false,
  date timestamp with time zone not null
    default current_timestamp
);
```

***

* Getum keyrt skipun a√∞ ofan eftir a√∞ vi√∞ tengjumst me√∞ `psql`
* Ef vi√∞ notum GUI t√≥l sko√∞um vi√∞ t√∂flur undir, t.d. pgAdmin:
  - `Schemas > public > tables`
  - E√∞a nota√∞ query t√≥l, h√¶gri smella √° gagnagrunn og `Query Tool`

***

* `id serial primary key` b√Ωr til _primary key_ d√°lk sem heitir `id`
  - Einstakur fyrir √æessa t√∂flu, engar tv√¶r ra√∞ir hafa sama primary key
  - √ûurfum ekki gera neitt √≠ `insert`, h√¶kkar sj√°lfkrafa

***

* `name varchar(64) not null unique` b√Ωr til d√°lk `name` me√∞ _variable characters_, st√∂fum af mismunandi bita lengd, eins og utf8
  - Tala √≠ sviga segir til um h√°markslengd, 64 stafir √≠ √æessu tilfelli
  - `not null`, ver√∞um a√∞ skilgreina gildi √æegar vi√∞ b√¶tum vi√∞ √≠ t√∂flu
  - `unique`, engar tv√¶r ra√∞ir mega hafa sama gildi √≠ t√∂flu

***

* `text text` b√Ωr til d√°lk `text` af t√Ωpunni `text`
  - Getur haldi√∞ utan um texta af hva√∞a lengd sem er
  - Gott fyrir texta sem vi√∞ vitum ekki hve langur getur or√∞i√∞
  - Sl√¶mt fyrir d√°lka sem vi√∞ viljum b√∫a til _indexa_ fyrir
  - M√° vera t√≥mt, f√°um √æ√° `NULL`

***

* `registered boolean default false` b√Ωr til d√°lk `registered` af t√Ωpunni `boolean`
  - Getur veri√∞ `true` e√∞a `false`, ekkert anna√∞
  - `default false` leyfir okkur a√∞ sleppa √æv√≠ a√∞ tiltaka √æegar vi√∞ b√¶tum vi√∞ r√∂√∞, ver√∞ur sj√°lfgefi√∞ `false`

***

* `date timestamp with time zone not null default current_timestamp` b√Ωr til d√°lk `date`
  - T√Ωpa er `timestamp with time zone`, dagst√≠mi me√∞ time zone
  - Sj√°lfgefi√∞ er √æa√∞ _n√∫na_, s√° t√≠mi sem r√∂√∞ er b√¶tt vi√∞
  - Gott a√∞ geyma me√∞ r√∂√∞um, s√©rstaklega √æegar vi√∞ erum a√∞ taka vi√∞ fr√° notendum

***

## B√¶ta vi√∞ t√∂flu ([insert](https://www.postgresql.org/docs/current/static/sql-insert.html))

```sql
INSERT INTO people
  (name, text)
VALUES
  ('J√≥n', 'Hall√≥');

INSERT INTO people
  (name, registered, text)
VALUES
  ('Anna', true, '')
RETURNING *;
-- RETURNING skilar okkur r√∂√∞ sem var√∞ til
-- Getum vali√∞ d√°lk, sj√° a√∞ ne√∞an
```

***

## Velja √∫r t√∂flu ([select](https://www.postgresql.org/docs/current/static/sql-select.html))

```sql
-- * velur alla d√°lka
-- Tilgreinum ekki takm√∂rkun
-- f√°um *allar* ra√∞ir
SELECT * FROM people;
```

```sql
id | name | text  | registered |             date
---+------+-------+------------+-------------------------------
 1 | J√≥n  | Hall√≥ | f          | 2019-01-23 17:17:46.730327+00
 2 | Anna |       | t          | 2019-01-23 17:17:46.730327+00
(2 rows)
```

***

```sql
-- Tilgreinum n√°kv√¶mlega hva√∞a d√°lka
SELECT name, registered FROM people;
```

```sql
 name | registered
------+------------
 J√≥n  | f
 Anna | t
(2 rows)
```

***

## Uppf√¶ra t√∂flu ([update](https://www.postgresql.org/docs/current/static/sql-update.html))

```sql
-- Notum where skilyr√∞i til a√∞ breyta
-- n√°kv√¶mri r√∂√∞, √°n where skilyr√∞is
-- uppf√¶rum vi√∞ *allar* ra√∞ir
UPDATE people SET NAME = '√ìli' WHERE id = 1;
```

```sql
UPDATE 1
```

***

## Ey√∞a √∫r t√∂flu ([delete](https://www.postgresql.org/docs/current/static/sql-update.html))

```sql
-- Sama h√©r, notum where skilyr√∞i
-- √Ån √æess EY√êUM VI√ê √ñLLUM F√ÜRSLUM üôÄ
DELETE FROM people WHERE id = 1;
```

```sql
DELETE 1
```

***

## CRUD

* √ûetta samansafn af a√∞ger√∞um kallast oftast _CRUD_
  - Create (√æ√° INSERT)
  - Read
  - Update
  - Delete

---

## Postgres og Node.js

* [node-postgres](https://github.com/brianc/node-postgres) er ‚Äûhrein‚Äú JavaScript √∫tf√¶rsla (notar ekki library √≠ √∂√∞rum forritunarm√°lum) √° PostgreSQL client
* `npm install --save pg`
* Callback og promise vi√∞m√≥t
* Sty√∞ur _prepared statements_ sem vi√∞ notum **alltaf** til a√∞ minnka l√≠kur √° _SQL injection_ √°r√°sum

***

## Tengjast gagnagrunni

Ef vi√∞ h√∂fum keyrandi gagnagrunn √° v√©l getum vi√∞ tengst √° nokkra vegu, ([sj√° skj√∂lun](https://node-postgres.com/features/connecting)):

* √ötb√∫a n√Ωjan `Client` og gefa uppl√Ωsingar um tengingu
  * B√Ωr til eina staka tengingu, sem vi√∞ ver√∞um s√≠√∞an a√∞ loka
  * Getum lent √≠ vandr√¶√∞um ef vi√∞ opnum of margar tengingar

***

* √ötb√∫a [_connection pool_](https://node-postgres.com/features/pooling) og tengjast gegnum √æa√∞
  * Endanlegt samansafn af tengingum √≠ ‚Äûpool‚Äú. Bi√∞jum um tengingu, f√°um √æegar laus, og skilum s√≠√∞an aftur fyrir n√¶sta
  * √Üskilegt fyrir vefforrit sem opna margar gagnagrunnstengingar

***

* √ç grunninn athugar `pg` hvort _environment breyturnar_ `PGUSER`, `PGHOST`, `PGPASSWORD`, `PGDATABASE` og `PGPORT` s√©u til og reynir a√∞ tengjast √æannig
* Getum l√≠ka tilgreint s√©rstaklega √æessi gildi √æegar vi√∞ b√∫um til 
* Tilgreinum _connection streng_, URL sem skilgreinir uppl√Ωsingar um hvernig tengjast skuli
  - Hentugt √æar sem allar uppl√Ωsingar eru √≠ einum streng
  - Vi√∞ notum √æetta a√∞allega √≠ okkar verkefnum

***

## D√¶mi

* [select](daemi/postgres/01.select.js)
* [insert](daemi/postgres/02.insert.js)
